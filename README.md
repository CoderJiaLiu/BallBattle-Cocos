# BallBattle

使用 LeanCloud Play 服务模拟的《球球大作战》demo。
主要体现由 Client 控制游戏逻辑的开发方式，即 Master Client。

## 玩法

输入房间 ID，加入房间（如果没有此房间，则创建）。用户 ID 随机生成。
使用 ⬆️⬇️⬅️➡️ 或 WSAD 来控制小球移动，吃掉场景中的食物（三角形，方形，六边形）则会增长体重（并减少速度）；遇到其他球（玩家），碰撞之后，体重较大者获胜，较小者将会死亡并重生。
右侧面板显示当前房间的玩家体重排行榜。

## 设计思路

### Battle

用于接收战斗中的自定义消息，根据消息解析，驱动场景节点及 UI 节点变化。

### Master

用于区分 Master 客户端与普通客户端，Master 组件用于生成房间数据及逻辑判断，只有 Master 的客户端才拥有这个组件，包括最初的房间的创建者和切换后的新房主。

### BallController 和 BallSimulator

用于区分本地客户端与其他客户端。BallController 用于玩家控制，并生成移动数据同步给其他客户端；BallSimulator 用于根据同步得到的玩家移动数据，模拟运动行为。

（其他脚本为游戏节点的控制脚本）

## 主要实现功能

### 匹配对战

最基础的房间 ID 匹配。

### 消息处理控制

由于从主场景加载到战斗场景，存在异步的资源加载过程，所以需要暂停 / 恢复消息队列的处理。
即 加入房间 -> 暂停消息处理 -> 加载战斗场景 -> 初始化战场 -> 恢复消息队列。

### 房间数据同步与保存

这个 demo 使用的是 Master Client 机制，但由于 Master Client 可能存在掉线等异常情况，所以需要将房间和玩家的部分数据保存至 Room Properties 和 Player Properties。

#### Room Properties

- 房间用时
- 战场的食物列表
- 食物最大 ID

#### Player Properties

- 位置
- 体重
- 速度

### 自定义消息

- 玩家出生：对于当前玩家，执行战场初始化逻辑；对于其他玩家，执行增加玩家逻辑。
- 吃食物：客户端移除内存中的食物节点，同步玩家体重。
- 杀死玩家：用于同步节点间碰撞事件。
- 玩家重生：用于重新初始化玩家数据。
- 生成食物：同步房间内的食物数据。
- 玩家离开：用于移除场景和 UI 对应节点。
- 游戏结束：用于返回主菜单场景。

### 移动同步

整体思路为玩家将移动变化时的数据（开始，停止，转向）同步给其他客户端，其他客户端根据节点，模拟玩家移动行为。
移动数据包括：当前位置，移动方向，当前时间戳。
其他客户端在收到移动数据后，根据当前所在位置 p0；移动改变时的时间戳，起始位置，当前的时间，计算出玩家当前应该所在的位置 p1，通过 p1 - p0 （向量减法）可得到校正后的移动方向，进行模拟。
